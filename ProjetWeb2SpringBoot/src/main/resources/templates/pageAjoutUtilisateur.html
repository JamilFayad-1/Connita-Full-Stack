<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>New friends</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/userCard.css">
</head>
<body>

<header th:include="menu :: menuFragment"></header>

<main>
    <!-- Left section -->
    <div id="left-section" th:include="leftNav :: leftNavFragment"></div>
    <!-- Middle section -->
    <div id="middle-section-friends" style="overflow: hidden">
        <div id="middle-section-friends-list">
            <h1 style="background: linear-gradient(#393939, #5c99dd) repeat-y; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent">Add new friends</h1>
            <div id="middle-section-search-bar">
                <form class="formSearchBar">
                    <div style="width: 85%; margin-left: 16%">
                        <input type="text" id="searchQuery" name="challengeName" placeholder="Look a specific friend"
                               oninput="filterChallenges()" required>
                        <img src="https://img.icons8.com/pastel-glyph/64/search--v1.png" id="searchIcon"
                             alt="search--v1"/>
                    </div>
                </form>
            </div>

            <!-- liste des membre non trouver dans la liste d'amies -->
            <div th:replace="listeAmie :: friendsListFragment(${listeUtilisateur})"></div>

        </div>

        <!-- 3d card render -->
        <div class="middle-section-user-card-container">
            <div id="app" class="user-card-element">
                <card data-image="images/cardBackgroundVideoFinal.gif">
                    <div slot="profilePic" class="card-profile-pic-wrapper">
                        <img alt="Profile pic" id="profilePicCard">
                    </div>
                    <h1 slot="name" id="nameCard"></h1>
                    <h3 slot="username" id="usernameCard"></h3>
                </card>
            </div>
        </div>

    </div>

    <!-- Friend request container -->
    <div class="demande-amie-container" id="toggle-demande-amie">
        <h1>Friend requests</h1>
        <div th:if="${#lists.isEmpty(listeUtilisateurDemandeAmie)}">
            <p>No friend requests found.</p>
        </div>
        <div th:each="demande : ${listeUtilisateurDemandeAmie}" class="demande-amie-element">
            <img th:src="${demande.photoProfilPath}" alt="profil picture">
            <h3 th:text="${demande.prenom + ' ' + demande.nom}"></h3>
            <div class="demande-amie-element-choice">
                <button type="button" name="AcceptRequest" id="AcceptedButton"
                        th:data-idAmieDemande="${demande.idMembre}"
                        th:data-idMembreDemande="${session.loggedInUser.idMembre}">Accept
                </button>
                <button type="button" name="DenyRequest" id="DeniedButton"
                        th:data-idMembreDemande="${session.loggedInUser.idMembre}">Decline
                </button>
            </div>
        </div>
        <div class="side-tab-info" id="sideTabInfo">Close tab</div>
        <div class="demande-amie-tab-button" id="sidetab-button">
            <i class="tab-button-icon-p1" id="sideTabButtonP1"></i>
            <i class="tab-button-icon-p2" id="sideTabButtonP2"></i>
        </div>
    </div>

</main>
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script th:inline="javascript">
    /*<![CDATA[*/

    document.addEventListener("DOMContentLoaded", function () {
        const sideTabContainer = document.getElementById('toggle-demande-amie');
        sideTabContainer.style.right = '0px';
        const sideTabButtonP1 = document.getElementById('sideTabButtonP1');
        const sideTabButtonP2 = document.getElementById('sideTabButtonP2');
        const addButton = document.querySelectorAll('#addButton');

        addButton.forEach(function (button) {
            button.addEventListener('click', function (event) {
                event.stopPropagation();

                const idMembre = this.getAttribute('data-idMembre');
                const idAmie = this.getAttribute('data-idAmie');

                console.log("IDMEMBRE RECU: " + idMembre);
                console.log("IDAMIE RECU: " + idAmie);

                const url = "/envoyerDemandeAmie?idMembre=" + idMembre + "&idAmie=" + idAmie;

                const xhr = new XMLHttpRequest();
                xhr.open("POST", url, true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            const addImage = button.querySelector('img');
                            const elementAdded = button.closest('.middle-section-friends-list-element');
                            const currentSrc = addImage.getAttribute('src');
                            addImage.setAttribute('src', 'images/Screenshot 2024-04-21 013229.png');
                            elementAdded.classList.add("added-user");
                            console.log("Friend request sent successfully!");
                        } else {
                            console.error("Error sending friend request:", xhr.statusText);
                        }
                    }
                };
                xhr.send();
            });
        });

        function reattachEventListeners() {
            const addButton = document.querySelectorAll('#middle-section-friends-list-container #addButton');
            const friendElements = document.querySelectorAll('#middle-section-friends-list-container #userElementDisplayed');
            addButton.forEach(function (button) {
                button.addEventListener('click', function () {
                    const idMembre = this.getAttribute('data-idMembre');
                    const idAmie = this.getAttribute('data-idAmie');

                    console.log("IDMEMBRE RECU: " + idMembre);
                    console.log("IDAMIE RECU: " + idAmie);

                    const url = "/envoyerDemandeAmie?idMembre=" + idMembre + "&idAmie=" + idAmie;

                    const xhr = new XMLHttpRequest();
                    xhr.open("POST", url, true);
                    xhr.setRequestHeader("Content-Type", "application/json");
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200) {
                                const addImage = button.querySelector('img');
                                const elementAdded = button.closest('.middle-section-friends-list-element');
                                const currentSrc = addImage.getAttribute('src');
                                addImage.setAttribute('src', 'images/Screenshot 2024-04-21 013229.png');
                                elementAdded.classList.add("added-user");
                                console.log("Friend request sent successfully!");
                            } else {
                                console.error("Error sending friend request:", xhr.statusText);
                            }
                        }
                    };
                    xhr.send();
                });
            });
        }

        function reloadFriendsList() {
            // Create a new XMLHttpRequest object
            const xhr = new XMLHttpRequest();

            const url = "/reloadFriendsList";
            xhr.open("POST", url, true);

            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    document.getElementById("middle-section-friends-list-container").outerHTML = xhr.responseText;
                    reattachEventListeners();
                }
            };
            xhr.send();
        }

        const acceptAmieButton = document.querySelectorAll('#AcceptedButton');
        const denyAmieButton = document.querySelectorAll('#DeniedButton');
        const friendRequestElements = document.querySelectorAll('.demande-amie-element');
        const friendRequestContainer = document.getElementById('toggle-demande-amie');

        acceptAmieButton.forEach(function (button) {
            button.addEventListener('click', function () {
                const idMembre = this.getAttribute('data-idMembreDemande');
                const idAmie = this.getAttribute('data-idAmieDemande');

                const url = "/AccepterAmitier?idMembre=" + idMembre + "&idAmie=" + idAmie;

                const xhr = new XMLHttpRequest();
                xhr.open("POST", url, true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            const parentElement = button.closest('.demande-amie-element');
                            parentElement.classList.add('demande-amie-disapear');
                            reloadFriendsList();
                            parentElement.remove();
                            if (friendRequestElements.length <= 1) {
                                friendRequestContainer.innerHTML = "<h1>Friend requests</h1>\n <p>No friend requests found.</p>";
                            }
                            console.log("Friend request sent successfully!");
                        } else {
                            console.error("Error sending friend request:", xhr.statusText);
                        }
                    }
                };
                xhr.send();
            });
        });

        denyAmieButton.forEach(function (button) {
            button.addEventListener('click', function () {
                const idMembre = this.getAttribute('data-idMembreDemande');

                const url = "/SupprimerAmitier?idMembre=" + idMembre;

                const xhr = new XMLHttpRequest();
                xhr.open("POST", url, true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            const parentElement = button.closest('.demande-amie-element');
                            parentElement.classList.add('demande-amie-disapear');
                            console.log("Friend request declined successfuly!");
                        } else {
                            console.error("Error declining friend request:", xhr.statusText);
                        }
                    }
                };
                xhr.send();
            });
        });


        const button = document.getElementById('sidetab-button');
        const sideTabInfo = document.getElementById('sideTabInfo');

        button.addEventListener('click', function () {
            var isOpen = sideTabContainer.style.right === '0px';
            if (sideTabContainer.style.right === '0px') {
                sideTabButtonP1.style.transform = 'rotate(16deg)';
                sideTabButtonP2.style.transform = 'rotate(-16deg)';
            }
            sideTabContainer.style.right = isOpen ? '-220px' : '0px';
        })

        button.addEventListener('mouseenter', function () {
            const isOpen = sideTabContainer.style.right === '-220px';
            sideTabInfo.style.display = 'flex';
            if (!isOpen) {
                sideTabInfo.textContent = 'Close tab';
                sideTabButtonP1.style.transform = 'rotate(-16deg)';
                sideTabButtonP2.style.transform = 'rotate(16deg)';
            } else {
                sideTabInfo.textContent = 'Open tab';
            }
        });

        button.addEventListener('mouseleave', function () {
            const isOpen = sideTabContainer.style.right === '-220px';
            sideTabInfo.style.display = 'none';
            if (!isOpen) {
                sideTabButtonP1.style.transform = 'rotate(0deg)';
                sideTabButtonP2.style.transform = 'rotate(0deg)';
            }
        });

        const userElementClicked = document.querySelectorAll('#userElementDisplayed');
        const userCardElement = document.getElementById('app');
        const middleSection = document.getElementById('middle-section-friends');

        userElementClicked.forEach(function (userElement) {
            userElement.addEventListener('click', function () {
                const profilePic = userElement.querySelector('.friends-list-element-picture img').getAttribute('src');
                const fullName = userElement.querySelector('.friends-list-element-name-region h2').textContent;
                const username = userElement.querySelector('.friends-list-element-name-region h3').textContent;
                middleSection.classList.add('middle-section-card-displayed');

                const userImageSlot = document.getElementById('profilePicCard');
                const userFullNameSlot = document.getElementById('nameCard');
                const usernameSlot = document.getElementById('usernameCard');


                if (userCardElement.classList.contains('animateIn')) {
                    userCardElement.classList.add('animateOut');
                    setTimeout(() => {
                        userCardElement.classList.remove('animateIn');
                        userCardElement.classList.remove('animateOut');
                        userImageSlot.src = profilePic;
                        userFullNameSlot.textContent = fullName;
                        usernameSlot.textContent = username;
                        userCardElement.classList.add('animateIn');
                    }, 1000);
                } else {
                    userImageSlot.src = profilePic;
                    userFullNameSlot.textContent = fullName;
                    usernameSlot.textContent = username;
                    userCardElement.classList.add('animateIn');
                    button.click();
                }
            });
        });

    });

    function filterChallenges(event) {
        let input, filter, element, elementName, i;
        input = document.getElementById("searchQuery");
        filter = input.value.toUpperCase();
        element = document.getElementsByClassName("idElementFriend");
        const searchIconButton = document.getElementById("searchIcon");

        input.addEventListener("keypress", function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchIconButton.click();
            }
        });

        // Check if Enter key is pressed
        searchIconButton.addEventListener('click', function () {
            for (i = 0; i < element.length; i++) {
                elementName = element[i].parentNode.nextElementSibling.querySelector("h2").textContent || element[i].parentNode.nextElementSibling.querySelector("h2").innerText;
                if (elementName.toUpperCase().indexOf(filter) > -1) {
                    element[i].parentNode.parentNode.style.display = "";
                } else {
                    element[i].parentNode.parentNode.style.display = "none";
                }
            }
        });
    }

    /*]]>*/
</script>
<script th:inline="javascript">

    Vue.config.devtools = true;

    Vue.component('card', {
        template: `
          <div class="card-wrap"
               ref="card"
               @click="handleCardClick">
            <div class="card"
                 :style="cardStyle">
              <div class="card-bg" :style="[cardBgTransform, cardBgImage]"></div>
              <div class="card-profile-pic">
                <slot name="profilePic"></slot>
              </div>
              <div class="card-info">
                <slot name="name"></slot>
                <slot name="username"></slot>
              </div>
            </div>
          </div>`,
        mounted() {
            this.width = this.$refs.card.offsetWidth;
            this.height = this.$refs.card.offsetHeight;

            document.addEventListener('mousemove', this.handleMouseMove);
        },
        props: ['dataImage'],
        data() {
            return {
                width: 0,
                height: 0,
                mouseX: 0,
                mouseY: 0,
                mouseLeaveDelay: null
            };
        },
        computed: {
            mousePX() {
                return this.mouseX / this.width;
            },
            mousePY() {
                return this.mouseY / this.height;
            },
            cardStyle() {
                const rX = this.mousePX * 9;
                const rY = this.mousePY * -10;
                return {
                    transform: `rotateY(${rX}deg) rotateX(${rY}deg)`
                };
            },
            cardBgTransform() {
                const tX = this.mousePX * -5;
                const tY = this.mousePY * -5;
                return {
                    transform: `translateX(${tX}px) translateY(${tY}px)`
                };
            },
            cardBgImage() {
                return {
                    backgroundImage: `url(${this.dataImage})`
                };
            }
        },
        methods: {
            handleMouseMove(e) {
                const mouseX = e.clientX;
                const mouseY = e.clientY;

                const cardRect = this.$refs.card.getBoundingClientRect();
                const cardX = cardRect.left + cardRect.width / 2;
                const cardY = cardRect.top + cardRect.height / 2;

                let relativeMouseX = mouseX - cardX;
                let relativeMouseY = mouseY - cardY;

                if (relativeMouseX > 3000) {
                    relativeMouseX = 3000;
                }

                if (relativeMouseY > 150) {
                    relativeMouseY = 150;
                }
                this.mouseX = relativeMouseX;
                this.mouseY = relativeMouseY;
            },
            handleCardClick() {

            }
        }
    });

    const app = new Vue({
        el: '#app'
    });

</script>
</body>
</html>