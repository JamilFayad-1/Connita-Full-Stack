<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>For you</title>
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
          integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>

</head>
<body>
<header th:include="menu :: menuFragment"></header>
<main>
    <!-- Left section -->
    <div id="left-section" th:include="leftNav :: leftNavFragment"></div>
    <!-- Middle section -->
    <div id="middle-section" style="position: relative">
        <div class="choicesFyp-container">
            <div class="choicesFyp">
                <a th:href="@{/fyp}"><h3>For you</h3></a>
                <a th:href="@{/yourContent}"><h3>Your work</h3></a>
            </div>
        </div>
        <div class="fypMakeAPost">
            <div class="fypMakeAPost-container" id="postElementContainer">
                <h2 style="font-family: 'montreal', sans-serif" id="shareThoughts">Share your thoughts</h2>
                <div class="fypMakeAPost-container-image" id="form-part-1">
                    <img th:src="${session.loggedInUser.photoProfilPath}" alt="You"/>
                </div>
                <div class="fypMakeAPost-container-form-container" id="form-part-2">
                    <form class="fypMakeAPost-container-form" th:action="@{/publier}" th:object="${publication}"
                          method="post" enctype="multipart/form-data">
                        <div class="container-form-element" style="display: none">
                            <label for="titreInputPublicationFormulaire">Title:</label>
                            <input id="titreInputPublicationFormulaire" value="" th:field="*{titre}" type="text"
                                   name="titre"
                                   minlength="5" autocomplete="off" placeholder="Enter your title"/>
                        </div>
                        <div class="container-form-element">
                            <label for="descriptionInputPublicationFormulaire">Caption:</label>
                            <input id="descriptionInputPublicationFormulaire"
                                   th:field="*{description}" type="text"
                                   name="description" minlength="5" autocomplete="off" required
                                   placeholder="Enter a caption"/>
                        </div>
                        <div class="container-form-element">
                            <input id="file-input" type="file" name="file" style="display: none"
                                   required/>
                            <i id="file-icon" class="fa-regular fa-image"></i>
                            <div class="container-form-element-button">
                                <button type="submit" id="publishButton">Publish</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="post-wrapper">
            <div th:each="publication : ${publications}" class="post-element" th:attr="data-publication-id=${publication.getId()}">
                <div class="post-image">
                    <img id="imagePosted" th:src="@{'/imageUtilisateur/' + ${publication.getImage()}}" alt="user image">
                </div>
                <div class="post-credentials">
                    <div class="post-profile-pic">
                        <img th:src="@{${publication.getMembre().getPhotoProfilPath()}}" alt="profile pic">
                    </div>
                    <div class="post-name-and-handle">
                        <h3>
                            <span class="username" th:text="${'@' + publication.getMembre().getUsername()}"></span>
                            <span class="description" th:text="${publication.getDescription()}"></span>
                        </h3>
                    </div>
                    <div class="post-like-button">
                        <h3 id="likeCounter" th:text="${publication.getLikes()}"></h3>
                        <i id="likeButton" class="fa-regular fa-heart fa-xl" th:data-idPost="${publication.getId_publication()}"></i>
                    </div>
                    <div class="post-comment-button">
                        <i id="commentButton" class="fa-regular fa-comment fa-xl"></i>
                    </div>
                </div>
                <div class="post-comments">
                    <div class="comments-wrapper">
                        <div class="comment-element">
                            <div class="comment-profile-pic">
                                <img src="images/Default-profile-pic.png" alt="image utilisateur">
                            </div>
                            <div class="comment-name-comment-container">
                                <h3 class="username-comment">@gwuliano </h3>
                                <h3 class="comment-text">fire pic man! I think we should do something next week that was too funnnn! next time we should try that new place next to the old port it smelled so good</h3>
                            </div>
                        </div>
                    </div>
                    <div class="user-comment-section">
                        <input type="text" id="comment-typed" class="comment-input" placeholder="Write a meaningful comment...">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Right section -->
    <div id="right-section" th:replace="rightFriendsList :: rightFriendsListFragment"></div>
</main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/ScrollTrigger.min.js"></script>
<script th:inline="javascript">
    function pullLikes(){
        let publications = document.querySelectorAll('.post-element');
        let likeButtons = document.querySelectorAll('#likeButton');
        fetch("/pullLikes")
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                $.each(data, function (index, like) {
                    publications.forEach(publication =>{
                        let publication_id = publication.getAttribute("data-publication-id");
                        if(publication_id == like.publication.id_publication){
                            console.log(publication_id);
                            likeButtons.forEach(button =>{
                                if(button.getAttribute("data-idPost") === publication_id){
                                    button.classList.remove('fa-regular');
                                    button.classList.add('fa-solid');
                                    button.style.color = "red";
                                    //likeCounter.style.color = 'red';
                                }
                            });
                        }

                    });
                });
            })
            .catch(error => {
                console.error('There was a problem with your fetch operation:', error);
            });
    }
    pullLikes();

    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.getElementById('file-input');
        const icon = document.getElementById('file-icon');

        icon.addEventListener('click', function () {
            fileInput.click();
        });

        const form = document.querySelector('.fypMakeAPost-container-form');

        form.addEventListener('submit', function(event) {

            setTimeout(function() {

                const descriptionField = document.getElementById('descriptionInputPublicationFormulaire');
                descriptionField.value = '';


                const fileInput = document.getElementById('file-input');
                fileInput.value = '';
            }, 100);
        });
    });

    const inputContainer = document.getElementById('postElementContainer');
    const formButton = document.getElementById('publishButton');

    formButton.addEventListener('mouseover', function () {
        inputContainer.style.border = "2px solid rgba(92, 153, 221, 0.8)";
        inputContainer.style.boxShadow = "rgba(92, 153, 221, 0.4) 0 10px 32px 0";
    });

    formButton.addEventListener('mouseout', function () {
        inputContainer.style.border = "";
        inputContainer.style.boxShadow = "";
    })

    const likeButtons = document.querySelectorAll('.post-like-button #likeButton');

    likeButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            const post = button.closest('.post-like-button');
            const likeCounter = post.querySelector('#likeCounter');
            let likeNumberCount = parseInt(likeCounter.textContent);
            if(button.classList.contains('fa-regular')){
                const idPost = this.getAttribute('data-idPost');

                console.log("IDPOST RECU: " + idPost);

                const url = "/likePost?idPost=" + idPost;

                const xhr = new XMLHttpRequest();
                xhr.open("POST", url, true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            likeNumberCount++;
                            likeCounter.textContent = likeNumberCount.toString();
                            button.classList.remove('fa-regular');
                            button.classList.add('fa-solid');
                            button.style.color = "red";
                            likeCounter.style.color = 'red';
                            console.log("Friend request sent successfully!");
                        } else {
                            console.error("Error sending friend request:", xhr.statusText);
                        }
                    }
                };
                xhr.send();
            }else {
                const idPost = this.getAttribute('data-idPost');

                console.log("IDPOST RECU: " + idPost);

                const url = "/removeLike?idPost=" + idPost;

                const xhr = new XMLHttpRequest();
                xhr.open("POST", url, true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            likeNumberCount--;
                            likeCounter.textContent = likeNumberCount.toString();
                            button.classList.remove('fa-solid');
                            button.classList.add('fa-regular');
                            button.style.color = "#2d2d2d";
                            likeCounter.style.color = '#2d2d2d';
                            console.log("Friend request sent successfully!");
                        } else {
                            console.error("Error sending friend request:", xhr.statusText);
                        }
                    }
                };
                xhr.send();
            }
        });
    });

    // fix for the image container in the posts
    const containers = document.querySelectorAll('.post-image');

    containers.forEach(function (container) {
        const image = container.querySelector('img');

        image.addEventListener('load', function () {
            const newHeight = image.offsetHeight + 2;
            container.style.height = newHeight + 'px';
        });
    });

    const shareButton = document.getElementById('shareThoughts');
    const part1 = document.getElementById('form-part-1');
    const part2 = document.getElementById('form-part-2');


    shareButton.style.width = '100%';
    shareButton.style.textAlign = 'center';
    shareButton.style.margin = '0';
    shareButton.style.alignContent = 'center';
    shareButton.style.fontSize = '1rem';
    shareButton.style.padding = '1rem';
    shareButton.style.color = '#4d4d4d';
    part1.style.display = 'none';
    part2.style.display = 'none';
    part1.style.pointerEvents = 'none';
    part2.style.pointerEvents = 'none';
    inputContainer.style.width = 'auto';
    inputContainer.style.height = 'auto';
    inputContainer.style.pointerEvents = 'auto';
    inputContainer.style.backgroundColor = 'rgb(245, 245, 245)';


    let formEnabeled = false;

    shareButton.addEventListener('mouseover', function () {
        shareButton.style.cursor = 'pointer';
        inputContainer.style.boxShadow = 'rgba(92, 153, 221, 0.5) 0px 10px 30px';
        inputContainer.style.backgroundColor = 'white';
    });

    shareButton.addEventListener('mouseout', function () {
        shareButton.style.cursor = 'default';
        inputContainer.style.boxShadow = '';
        inputContainer.style.backgroundColor = 'rgb(245, 245, 245)';
    });

    inputContainer.addEventListener('click', function () {
        if (formEnabeled === false) {
            formEnabeled = true;
            shareButton.classList.add('animateShareThoughts');
            const inputCaption = document.getElementById('descriptionInputPublicationFormulaire');
            inputCaption.value = "";
            setTimeout(() => {
                inputContainer.classList.add('animateInputContainer');
            }, 200)
            setTimeout(() => {
                shareButton.style.display = 'none';
                part1.style.display = 'flex';
                part2.style.display = 'block';
                part1.style.pointerEvents = 'auto';
                part2.style.pointerEvents = 'auto';
            }, 2000)
        }
    });

    const commentButton = document.querySelectorAll('.post-comment-button #commentButton');

    commentButton.forEach(function(button) {
        button.addEventListener('click', function(){
            if(button.classList.contains('fa-regular')){
                button.classList.remove('fa-regular');
                button.classList.add('fa-solid');
            }else {
                button.classList.remove('fa-solid');
                button.classList.add('fa-regular');
            }
        })
    });


</script>
</body>
</html>