<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>Exercices</title>
</head>
<body>
<input type="number" id="memberId" name="memberId" th:value="${session.loggedInUser.idMembre}" style="display: none">
<!-- Include menu -->
<header th:include="menu :: menuFragment"></header>

<main>
    <!-- Left section -->
    <div id="left-section" th:include="leftNav :: leftNavFragment"></div>
    <!-- Middle section -->
    <div id="middle-section" style="position: relative; overflow: hidden">
        <div class="middle-section-exercises-wrapper">
            <h1 style="z-index: 3">Exercises</h1>
            <nav class="exercises-list-container">
                <a href="#" class="languageElement" data-language="italian">Italian</a>
                <a href="#" class="languageElement" data-language="french">French</a>
                <a href="#" class="languageElement" data-language="spanish">Spanish</a>
                <a href="#" class="languageElement" data-language="german">German</a>
                <span id="navSpan"></span>
            </nav>
            <nav class="exercises-completion-list-container">
                <div class="completion-list-checkmark" id="animContainerCheckmark1" ></div>
                <div class="completion-list-checkmark" id="animContainerCheckmark2"></div>
                <div class="completion-list-checkmark" id="animContainerCheckmark3"></div>
                <div class="completion-list-checkmark" id="animContainerCheckmark4"></div>
            </nav>
        </div>
        <div class="exercises-element-container"></div>
        <div class="animation-container-exercise" id="animationContainer"></div>
        <div class="confettie-container-exercise" id="confettieContainer"></div>
    </div>
    <!-- Right section -->
    <div id="right-section" th:if="${session.loggedInUser != null}"
         th:replace="rightFriendsList :: rightFriendsListFragment"></div>
</main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.7/lottie.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
<script th:inline="javascript">
    const animationIdle = bodymovin.loadAnimation({
        container: document.getElementById('animationContainer'),
        renderer: 'svg',
        loop: true,
        autoplay: true,
        path: 'gif/StudyingAnim.json'
    });

    const confettieAnim = bodymovin.loadAnimation({
        container: document.getElementById('confettieContainer'),
        renderer: 'svg',
        loop: false,
        autoplay: false,
        path: 'gif/ConfettieAnim.json'
    });
    confettieAnim.goToAndStop(300, true);

    const checkmark1 = bodymovin.loadAnimation({
        container: document.getElementById('animContainerCheckmark1'),
        renderer: 'svg',
        loop: false,
        autoplay: false,
        path: 'gif/CheckmarkAnim.json'
    });


    const checkmark2 = bodymovin.loadAnimation({
        container: document.getElementById('animContainerCheckmark2'),
        renderer: 'svg',
        loop: false,
        autoplay: false,
        path: 'gif/CheckmarkAnim.json'
    });


    const checkmark3 = bodymovin.loadAnimation({
        container: document.getElementById('animContainerCheckmark3'),
        renderer: 'svg',
        loop: false,
        autoplay: false,
        path: 'gif/CheckmarkAnim.json'
    });


    const checkmark4 = bodymovin.loadAnimation({
        container: document.getElementById('animContainerCheckmark4'),
        renderer: 'svg',
        loop: false,
        autoplay: false,
        path: 'gif/CheckmarkAnim.json'
    });

    const listeExerciceCompletion = /*[[${listeExercices}]]*/ [];

    listeExerciceCompletion.forEach(function(exercice, index){
        console.log(exercice);
        if(exercice.completeStatus === true){
            let animName = "checkmark" + (index + 1);
            console.log("CHECKMARK NAME: ", animName);
            switch(animName){
                case "checkmark1":
                    checkmark1.goToAndStop(121, true);
                    break;
                case "checkmark2":
                    checkmark2.goToAndStop(121, true);
                    break;
                case "checkmark3":
                    checkmark3.goToAndStop(121, true);
                    break;
                case "checkmark4":
                    checkmark4.goToAndStop(121, true);
                    break;
            }
        }
    })

    const navSpan = document.getElementById('navSpan');
    const languageElements = document.querySelectorAll('.languageElement');
    const questionsContainer = document.querySelector('.exercises-element-container');
    let currentElementClicked;
    let currentOpacity = 0;
    let currentLanguage;

    //Les effet du hover et click sur le nav de language
    languageElements.forEach(function (element, index) {
        element.addEventListener('click', function (event) {
            const animationContainer = document.getElementById('animationContainer');
            animationContainer.style.display = "none";
            if (index === 0) {
                currentElementClicked = "0%";
                currentOpacity = "1";
                loadLanguage(italian);
                currentLanguage = "italian";
            } else if (index === 1) {
                currentElementClicked = "25%";
                currentOpacity = "1";
                loadLanguage(french);
                currentLanguage = "french";
            } else if (index === 2) {
                currentElementClicked = "50%";
                currentOpacity = "1";
                loadLanguage(spanish);
                currentLanguage = "spanish";
            } else if (index === 3) {
                currentElementClicked = "75%";
                currentOpacity = "1";
                loadLanguage(german);
                currentLanguage = "german";
            }
            gsap.to(questionsContainer, {
                scrollTop: 0,
                duration: 0.1
            })
        })
        navSpan.style.left = currentElementClicked;
        navSpan.style.opacity = currentOpacity;
        element.addEventListener('mouseover', function (event) {
            if (index === 0) {
                navSpan.style.left = "0%";
                navSpan.style.opacity = "1";
            } else if (index === 1) {
                navSpan.style.left = "25%";
                navSpan.style.opacity = "1";
            } else if (index === 2) {
                navSpan.style.left = "50%";
                navSpan.style.opacity = "1";
            } else if (index === 3) {
                navSpan.style.left = "75%";
                navSpan.style.opacity = "1";
            }
        })
        element.addEventListener('mouseout', function (event) {
            navSpan.style.left = currentElementClicked;
            navSpan.style.opacity = currentOpacity;
        })
    })

    // Définir les constante d'objet de langue.
    const italian = [
        {
            question: "How do we say 'Hello' in Italian?",
            answers: [
                {text: "Sol!", correct: false},
                {text: "Ciao!", correct: true},
                {text: "Verde!", correct: false},
                {text: "Prego!", correct: false}
            ]
        },
        {
            question: "How do we say 'Thank you' in Italian?",
            answers: [
                {text: "Grazie!", correct: true},
                {text: "Per favore!", correct: false},
                {text: "Buongiorno!", correct: false},
                {text: "Scusa!", correct: false}
            ]
        },
        {
            question: "How do we say 'Goodbye' in Italian?",
            answers: [
                {text: "Arrivederci!", correct: true},
                {text: "Buona notte!", correct: false},
                {text: "Per favore!", correct: false},
                {text: "Salute!", correct: false}
            ]
        },
        {
            question: "How do we say 'Please' in Italian?",
            answers: [
                {text: "Per favore!", correct: true},
                {text: "Grazie!", correct: false},
                {text: "Ciao!", correct: false},
                {text: "Scusi!", correct: false}
            ]
        },
        {
            question: "How do we say 'Yes' in Italian?",
            answers: [
                {text: "No!", correct: false},
                {text: "Sì!", correct: true},
                {text: "Forse!", correct: false},
                {text: "Niente!", correct: false}
            ]
        },
        {
            question: "How do we say 'No' in Italian?",
            answers: [
                {text: "Sì!", correct: false},
                {text: "No!", correct: true},
                {text: "Non lo so!", correct: false},
                {text: "Mai!", correct: false}
            ]
        }
    ];

    const french = [
        {
            question: "How do we say 'Hello' in French?",
            answers: [
                {text: "Bonjour!", correct: true},
                {text: "Salut!", correct: true},
                {text: "Merci!", correct: false},
                {text: "Pardon!", correct: false}
            ]
        },
        {
            question: "How do we say 'Thank you' in French?",
            answers: [
                {text: "Merci!", correct: true},
                {text: "S'il vous plaît!", correct: false},
                {text: "Bonsoir!", correct: false},
                {text: "Pardon!", correct: false}
            ]
        },
        {
            question: "How do we say 'Goodbye' in French?",
            answers: [
                {text: "Au revoir!", correct: true},
                {text: "Bonne nuit!", correct: false},
                {text: "Merci!", correct: false},
                {text: "Santé!", correct: false}
            ]
        },
        {
            question: "How do we say 'Please' in French?",
            answers: [
                {text: "S'il vous plaît!", correct: true},
                {text: "Merci!", correct: false},
                {text: "Bonjour!", correct: false},
                {text: "Excusez-moi!", correct: false}
            ]
        },
        {
            question: "How do we say 'Yes' in French?",
            answers: [
                {text: "Non!", correct: false},
                {text: "Oui!", correct: true},
                {text: "Peut-être!", correct: false},
                {text: "Jamais!", correct: false}
            ]
        },
        {
            question: "How do we say 'No' in French?",
            answers: [
                {text: "Oui!", correct: false},
                {text: "Non!", correct: true},
                {text: "Je ne sais pas!", correct: false},
                {text: "Jamais!", correct: false}
            ]
        }
    ];

    const spanish = [
        {
            question: "How do we say 'Hello' in Spanish?",
            answers: [
                {text: "Hola!", correct: true},
                {text: "Adiós!", correct: false},
                {text: "Gracias!", correct: false},
                {text: "Por favor!", correct: false}
            ]
        },
        {
            question: "How do we say 'Thank you' in Spanish?",
            answers: [
                {text: "Gracias!", correct: true},
                {text: "Por favor!", correct: false},
                {text: "Buenos días!", correct: false},
                {text: "Perdón!", correct: false}
            ]
        },
        {
            question: "How do we say 'Goodbye' in Spanish?",
            answers: [
                {text: "Adiós!", correct: true},
                {text: "Buenas noches!", correct: false},
                {text: "Por favor!", correct: false},
                {text: "Salud!", correct: false}
            ]
        },
        {
            question: "How do we say 'Please' in Spanish?",
            answers: [
                {text: "Por favor!", correct: true},
                {text: "Gracias!", correct: false},
                {text: "Hola!", correct: false},
                {text: "Disculpa!", correct: false}
            ]
        },
        {
            question: "How do we say 'Yes' in Spanish?",
            answers: [
                {text: "No!", correct: false},
                {text: "Sí!", correct: true},
                {text: "Tal vez!", correct: false},
                {text: "Nada!", correct: false}
            ]
        },
        {
            question: "How do we say 'No' in Spanish?",
            answers: [
                {text: "Sí!", correct: false},
                {text: "No!", correct: true},
                {text: "No sé!", correct: false},
                {text: "Nunca!", correct: false}
            ]
        }
    ];

    const german = [
        {
            question: "How do we say 'Hello' in German?",
            answers: [
                {text: "Hallo!", correct: true},
                {text: "Tschüss!", correct: false},
                {text: "Danke!", correct: false},
                {text: "Bitte!", correct: false}
            ]
        },
        {
            question: "How do we say 'Thank you' in German?",
            answers: [
                {text: "Danke!", correct: true},
                {text: "Bitte!", correct: false},
                {text: "Guten Morgen!", correct: false},
                {text: "Entschuldigung!", correct: false}
            ]
        },
        {
            question: "How do we say 'Goodbye' in German?",
            answers: [
                {text: "Auf Wiedersehen!", correct: true},
                {text: "Gute Nacht!", correct: false},
                {text: "Bitte!", correct: false},
                {text: "Gesundheit!", correct: false}
            ]
        },
        {
            question: "How do we say 'Please' in German?",
            answers: [
                {text: "Bitte!", correct: true},
                {text: "Danke!", correct: false},
                {text: "Hallo!", correct: false},
                {text: "Entschuldigung!", correct: false}
            ]
        },
        {
            question: "How do we say 'Yes' in German?",
            answers: [
                {text: "Nein!", correct: false},
                {text: "Ja!", correct: true},
                {text: "Vielleicht!", correct: false},
                {text: "Nichts!", correct: false}
            ]
        },
        {
            question: "How do we say 'No' in German?",
            answers: [
                {text: "Ja!", correct: false},
                {text: "Nein!", correct: true},
                {text: "Ich weiß nicht!", correct: false},
                {text: "Niemals!", correct: false}
            ]
        }
    ];

    //fonction qui affiche les questions du language clicker par l'utilisateur
    function loadLanguage(language) {
        questionsContainer.innerHTML = '';

        const questionElements = [];

        for (let i = 0; i < language.length; i++) {
            const questionObj = language[i];

            const questionElementContainer = document.createElement('div');
            questionElementContainer.classList.add('exercise-element-question-container');

            const headerAndQuestion = document.createElement('div');
            headerAndQuestion.classList.add('exercise-header-and-question');

            const indexSpan = document.createElement('span');
            indexSpan.textContent = (i+1) + ')';

            const questionTitle = document.createElement('h3');
            questionTitle.textContent = questionObj.question;

            headerAndQuestion.appendChild(indexSpan);
            headerAndQuestion.appendChild(questionTitle);

            const answersGrid = document.createElement('div');
            answersGrid.classList.add('exercise-answer-inputs-grid');

            questionObj.answers.forEach(answer => {
                const answerButton = document.createElement('div');
                answerButton.classList.add('exercise-answer-button');
                answerButton.textContent = answer.text;
                answerButton.dataset.correct = answer.correct;
                answerButton.addEventListener('click', () => {
                    Array.from(answersGrid.children).forEach(btn => {
                        btn.classList.remove('selected');
                        btn.style.backgroundColor = "#dedede";
                    });
                    // Select the clicked button
                    answerButton.classList.add('selected');
                    answerButton.style.backgroundColor = "rgba(92, 153, 221, 0.3)";
                });
                answersGrid.appendChild(answerButton);
            });

            questionElementContainer.appendChild(headerAndQuestion);
            questionElementContainer.appendChild(answersGrid);

            questionsContainer.appendChild(questionElementContainer);

            questionElements.push(questionElementContainer);
        }
        gsap.from(questionElements, {
            delay: 0.2,
            opacity: 0,
            y: 20,
            duration: 0.6,
            stagger: 0.3
        });

        const submitAndScoreContainer = document.createElement('div');
        submitAndScoreContainer.classList.add('submit-and-score-container');

        const submitButton = document.createElement('button');
        submitButton.id = 'submit-button';
        submitButton.textContent = 'Submit';
        submitButton.addEventListener('click', function(event) {
            const questionContainers = document.querySelectorAll('.exercise-element-question-container');
            let emptyAnswers = 0;

            questionContainers.forEach(questionContainer => {
                const answerButtons = questionContainer.querySelectorAll('.exercise-answer-button');
                let isAnySelected = false;

                answerButtons.forEach(button => {
                    if (button.classList.contains('selected')) {
                        isAnySelected = true;
                    }
                });

                if (!isAnySelected) {
                    emptyAnswers++;
                }
            });

            if (emptyAnswers >= 1) {
                event.preventDefault();
                alert('Please answer all questions before submitting.');
            } else {
                verifyAnswers();
            }
        });

        const scoreSpan = document.createElement('span');
        scoreSpan.id = 'score-span';

        submitAndScoreContainer.appendChild(submitButton);
        submitAndScoreContainer.appendChild(scoreSpan);

        questionsContainer.appendChild(submitAndScoreContainer);
    }

    //fonction qui vérifie les réponse donner par l'utilisateur
    const submitButton = document.getElementById('submit-button');
    function verifyAnswers() {
        const questionContainers = document.querySelectorAll('.exercise-element-question-container');
        const scoreDisplay = document.getElementById('score-span');
        let correctAnswers = 0;

        const submitButton = document.getElementById('submit-button');
        if (submitButton.textContent === 'Submit') {
            // Submit button action
            questionContainers.forEach(questionContainer => {
                const answerButtons = questionContainer.querySelectorAll('.exercise-answer-button');

                answerButtons.forEach(button => {
                    if (button.classList.contains('selected')) {
                        if (button.dataset.correct === 'true') {
                            button.style.backgroundColor = '#a0fda0';
                            correctAnswers++;
                        } else {
                            button.style.backgroundColor = '#fc9494';
                        }
                    } else if(button.dataset.correct === 'true') {
                        button.style.backgroundColor = '#a0fda0';
                    }else {
                        button.style.backgroundColor = '';
                    }
                });

                let boxShadowSetting;
                if (correctAnswers === 6) {
                    scoreDisplay.style.color = '#a0fda0';
                    scoreDisplay.style.opacity = "1";
                    boxShadowSetting = "0 0 30px 2px rgba(160, 253, 160, 0.4)";
                    confettieAnim.playSegments([1, 300], true);
                    switch(currentLanguage){
                        case "italian":
                            checkmark1.playSegments([1, 121], true);
                            break;
                        case "french":
                            checkmark2.playSegments([1, 121], true);
                            break;
                        case "spanish":
                            checkmark3.playSegments([1, 121], true);
                            break;
                        case "german":
                            checkmark4.playSegments([1, 121], true);
                            break;
                    }
                    const memberId = $('#memberId').val();
                    console.log("ID : ", memberId);
                    console.log("LANGUAGE NAME : ", currentLanguage);
                    $.ajax({
                        url: '/api/exercices/update',
                        type: 'GET',
                        contentType: 'application/json',
                        data: {
                            memberId: memberId,
                            exerciceName: currentLanguage
                        },
                        success: function(response) {
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            alert('Error occurred while updating the exercice: ' + errorThrown);
                        }
                    });
                } else {
                    scoreDisplay.style.color = '#fc9494';
                    scoreDisplay.style.opacity = "1";
                    boxShadowSetting = "0 0 30px 2px rgba(252, 148, 148, 0.4)";
                }

                scoreDisplay.textContent = "Score: " + correctAnswers + "/6";
                scoreDisplay.style.boxShadow = boxShadowSetting;
                scoreDisplay.style.opacity = "1";

                gsap.to(questionsContainer, {
                    scrollTop: 0,
                    duration: 0.3,
                    scrub: 1
                })
            });

            submitButton.textContent = "Reset";
        } else {
            // Reset button action
            submitButton.textContent = "Submit";
            scoreDisplay.style.boxShadow = 'none';
            scoreDisplay.textContent = "";
            scoreDisplay.style.opacity = "0";
            gsap.to(questionsContainer, {
                scrollTop: 0,
                duration: 0.3,
                scrub: true
            });

            questionContainers.forEach(questionContainer => {
                const answerButtons = questionContainer.querySelectorAll('.exercise-answer-button');

                answerButtons.forEach(button => {
                    button.style.backgroundColor = '';
                    button.classList.remove('selected');
                });
            });
        }
    }
</script>
</body>
</html>
